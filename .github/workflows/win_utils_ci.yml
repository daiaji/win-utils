name: Win-Utils CI

on:
  push:
    branches: ["main", "master", "FFI"]
    paths:
      - 'win-utils/**'
      - '**'
      - '.github/workflows/win_utils_ci.yml'
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

# 定义全局变量，方便两边 Job 使用同一个 Key
env:
  # [关键] 手动控制版本。如果你更新了 luajit 源码，请升级这个数字 (v4 -> v5)
  LUAJIT_CACHE_KEY: windows-luajit-52compat-v4
  LUAJIT_BIN_DIR: ${{ github.workspace }}\luajit_build

jobs:
  # ===========================================================================
  # Job 1: Build Keeper
  # 职责：确保缓存里有东西。如果有，它什么都不做。如果没有，它负责编译并存入缓存。
  # ===========================================================================
  build-luajit:
    name: Ensure LuaJIT Cache
    runs-on: windows-latest
    steps:
      # 1. 直接检查缓存是否存在 (不需要 Checkout 代码！)
      - name: Check Cache
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ env.LUAJIT_CACHE_KEY }}
          lookup-only: true # [优化] 只检查存在性，不下载文件，节省时间

      # 2. 只有当缓存【不存在】时，才需要 Checkout 代码
      - name: Checkout (Only on Miss)
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 3. 只有当缓存【不存在】时，才配置环境
      - name: Setup MSVC (Only on Miss)
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        uses: ilammy/msvc-dev-cmd@v1

      # 4. 只有当缓存【不存在】时，才编译
      # 编译成功后，actions/cache 会在 Post 阶段自动保存缓存
      - name: Build LuaJIT (Only on Miss)
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo "::notice ::Cache miss! Compiling LuaJIT..."
          cd vendor/luajit/src
          call msvcbuild.bat lua52compat
          if %errorlevel% neq 0 exit /b %errorlevel%
          
          if not exist "%LUAJIT_BIN_DIR%\bin" mkdir "%LUAJIT_BIN_DIR%\bin"
          copy luajit.exe "%LUAJIT_BIN_DIR%\bin\"
          copy lua51.dll "%LUAJIT_BIN_DIR%\bin\"
          
          if not exist "%LUAJIT_BIN_DIR%\jit" mkdir "%LUAJIT_BIN_DIR%\jit"
          copy jit\*.lua "%LUAJIT_BIN_DIR%\jit\"

  # ===========================================================================
  # Job 2: Run Tests
  # 职责：下载缓存，签出测试代码，运行。
  # ===========================================================================
  test-suite:
    name: Run Tests
    needs: build-luajit # 必须等待 Job 1 确认缓存已就绪
    runs-on: windows-latest
    
    steps:
      # 1. 签出你的源码 (这是必须的，因为要跑这里的测试代码)
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. 恢复 LuaJIT 缓存 (Job 1 保证了它一定存在)
      - name: Restore LuaJIT from Cache
        uses: actions/cache/restore@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ env.LUAJIT_CACHE_KEY }}
          fail-on-cache-miss: true # [保险] 如果 Job 1 成功了但这里没找到缓存，直接报错

      # 3. 组装环境 (无需修改逻辑)
      - name: Assemble Test Environment
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          $stage = New-Item -ItemType Directory -Path "stage" -Force
          $bin   = New-Item -ItemType Directory -Path "stage/bin"
          $lua   = New-Item -ItemType Directory -Path "stage/lua"
          $tests = New-Item -ItemType Directory -Path "stage/tests"
          
          # 1. Binaries (从缓存目录复制)
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\bin\*" $bin
          
          # 2. Lua Libs
          $pkgDest = New-Item -ItemType Directory -Path "$lua/win-utils" -Force
          if (Test-Path "win-utils\init.lua") {
              Copy-Item "win-utils\*" $pkgDest -Recurse 
              if (Test-Path "win-utils\tests") { Copy-Item "win-utils\tests\*" $tests -Recurse }
          } elseif (Test-Path "init.lua") {
              Get-ChildItem -Path . -Exclude ".git", ".github", "stage", "luajit_build", "vendor", "test_sandbox" | Copy-Item -Destination $pkgDest -Recurse
              if (Test-Path "tests") { Copy-Item "tests\*" $tests -Recurse }
          }
          
          # 3. Deps
          if (Test-Path "vendor/lua-ffi-bindings/ffi") {
             Copy-Item "vendor/lua-ffi-bindings/ffi" "$lua" -Recurse
             if (Test-Path "vendor/lua-ffi-bindings/req.lua") { Copy-Item "vendor/lua-ffi-bindings/req.lua" "$lua/ffi/" }
          } elseif (Test-Path "vendor/lua-ffi-bindings/req.lua") {
             $ffiDest = New-Item -ItemType Directory -Path "$lua/ffi" -Force
             Copy-Item "vendor/lua-ffi-bindings/*" "$ffiDest" -Recurse -Exclude ".git"
          }
          
          # 4. Lua Ext
          if (Test-Path "vendor/lua-ext") {
             $extDir = New-Item -ItemType Directory -Path (Join-Path $lua.FullName "ext") -Force
             Copy-Item "vendor/lua-ext/*.lua" -Destination $extDir.FullName -Force
             $extLuaInside = Join-Path $extDir.FullName "ext.lua"
             if (Test-Path $extLuaInside) { Move-Item -Path $extLuaInside -Destination $lua.FullName -Force }
          }

          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/bluebird75/luaunit/master/luaunit.lua" -OutFile "$lua/luaunit.lua"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/daiaji/luafilesystem/main/lfs_ffi.lua" -OutFile "$lua/lfs_ffi.lua"

          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\jit" "$lua/jit" -Recurse

          echo "TEST_STAGE=$($stage.FullName)" >> $env:GITHUB_ENV

      - name: Run Tests
        shell: pwsh
        env:
          LUA_PATH: ${{ env.TEST_STAGE }}\tests\?.lua;${{ env.TEST_STAGE }}\lua\?.lua;${{ env.TEST_STAGE }}\lua\?\init.lua;;
        run: |
          Write-Host "Running tests..."
          & "${{ env.TEST_STAGE }}\bin\luajit.exe" "${{ env.TEST_STAGE }}\tests\run_tests.lua" -v