name: Win-Utils CI

on:
  push:
    branches: ["main", "master", "FFI"]
    paths:
      - 'win-utils/**'
      - '**'
      - '.github/workflows/win_utils_ci.yml'
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  test-suite:
    name: Full Test Suite (Windows)
    runs-on: windows-latest
    
    env:
      LUAJIT_BIN_DIR: ${{ github.workspace }}\.luajit
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache LuaJIT Build
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ runner.os }}-luajit-${{ hashFiles('vendor/luajit/src/luajit.h') }}
          restore-keys: |
            ${{ runner.os }}-luajit-

      - name: Setup MSVC
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build LuaJIT
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd vendor/luajit/src
          call msvcbuild.bat gc64
          if %errorlevel% neq 0 exit /b %errorlevel%
          
          mkdir "%LUAJIT_BIN_DIR%\bin"
          copy luajit.exe "%LUAJIT_BIN_DIR%\bin\"
          copy lua51.dll "%LUAJIT_BIN_DIR%\bin\"
          
          mkdir "%LUAJIT_BIN_DIR%\jit"
          copy jit\*.lua "%LUAJIT_BIN_DIR%\jit\"

      - name: Assemble Test Environment
        shell: pwsh
        run: |
          $stage = New-Item -ItemType Directory -Path "stage" -Force
          $bin   = New-Item -ItemType Directory -Path "stage/bin"
          $lua   = New-Item -ItemType Directory -Path "stage/lua"
          $tests = New-Item -ItemType Directory -Path "stage/tests"
          
          # 1. Binaries
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\bin\*" $bin
          
          # 2. Lua Libs
          
          # A. win-utils (Library code only)
          $pkgDest = New-Item -ItemType Directory -Path "$lua/win-utils" -Force
          
          if (Test-Path "win-utils\init.lua") {
              Write-Host "Detected subdirectory structure."
              # Copy library code
              Copy-Item "win-utils\*" $pkgDest -Recurse -Exclude "tests"
              
              # Copy tests to stage/tests (flat)
              if (Test-Path "win-utils\tests") {
                  Copy-Item "win-utils\tests\*" $tests -Recurse
              }
          } elseif (Test-Path "init.lua") {
              Write-Host "Detected root directory structure."
              Get-ChildItem -Path . -Exclude ".git", ".github", "stage", ".luajit", "vendor", "test_sandbox", "tests" | Copy-Item -Destination $pkgDest -Recurse
              
              if (Test-Path "tests") {
                  Copy-Item "tests\*" $tests -Recurse
              }
          } else {
              Write-Error "Could not find init.lua in '.' or './win-utils'. Layout unknown."
              exit 1
          }
          
          # B. lua-ffi-bindings (Fixed Copy Logic)
          # We need stage/lua/ffi/req.lua
          if (Test-Path "vendor/lua-ffi-bindings/ffi") {
             # Copy the 'ffi' folder itself into stage/lua, creating stage/lua/ffi
             Copy-Item "vendor/lua-ffi-bindings/ffi" "$lua" -Recurse
          } elseif (Test-Path "vendor/lua-ffi-bindings/req.lua") {
             # Fallback: Flat repo structure
             $ffiDest = New-Item -ItemType Directory -Path "$lua/ffi" -Force
             Copy-Item "vendor/lua-ffi-bindings/*" "$ffiDest" -Recurse -Exclude ".git"
          } else {
             Write-Warning "vendor/lua-ffi-bindings not found or structure unknown."
          }
          
          # C. lua-ext
          if (Test-Path "vendor/lua-ext") {
             # Need stage/lua/ext.lua and stage/lua/ext/
             if (Test-Path "vendor/lua-ext/ext.lua") {
                 Copy-Item "vendor/lua-ext/ext.lua" "$lua"
             }
             if (Test-Path "vendor/lua-ext/ext") {
                 Copy-Item "vendor/lua-ext/ext" "$lua" -Recurse
             }
          }

          # D. LuaUnit
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/bluebird75/luaunit/master/luaunit.lua" -OutFile "$lua/luaunit.lua"

          # E. JIT Libs
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\jit" "$lua/jit" -Recurse

          # Save Path
          echo "TEST_STAGE=$($stage.FullName)" >> $env:GITHUB_ENV

      - name: Run Tests
        shell: pwsh
        env:
          # [CHANGED] Added 'stage/tests/?.lua' to LUA_PATH to allow requiring spec files by name
          # Also ensured stage/lua matches standard package structure
          LUA_PATH: ${{ env.TEST_STAGE }}\tests\?.lua;${{ env.TEST_STAGE }}\lua\?.lua;${{ env.TEST_STAGE }}\lua\?\init.lua;;
        run: |
          Write-Host "Running tests in staged environment (PowerShell)..."
          & "${{ env.TEST_STAGE }}\bin\luajit.exe" "${{ env.TEST_STAGE }}\tests\run_tests.lua" -v